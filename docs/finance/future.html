<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-11-21 Tue 14:00 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title></title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="weiwu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../styles/demo/css/demo.css"/>
<link href="https://fonts.proxy.ustclug.org/css?family=Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet" type="text/css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline47">1. future trade simulation</a>
<ul>
<li><a href="#orgheadline2">1.1. functions</a>
<ul>
<li><a href="#orgheadline1">1.1.1. constant maturity</a></li>
</ul>
</li>
<li><a href="#orgheadline15">1.2. futures:</a>
<ul>
<li><a href="#orgheadline3">1.2.1. 期货合约命名规则：</a></li>
<li><a href="#orgheadline6">1.2.2. 期货合约品种:</a></li>
<li><a href="#orgheadline11">1.2.3. 国内future exchange:</a></li>
<li><a href="#orgheadline12">1.2.4. dominant_future - 期货主力合约</a></li>
<li><a href="#orgheadline13">1.2.5. trading calendar:</a></li>
<li><a href="#orgheadline14">1.2.6. future attributes:</a></li>
</ul>
</li>
<li><a href="#orgheadline24">1.3. 算法</a></li>
<li><a href="#orgheadline46">1.4. backtesting</a>
<ul>
<li><a href="#orgheadline25">1.4.1. 回测初始化参数(setting initial parameters)：</a></li>
<li><a href="#orgheadline45">1.4.2. backtesting：</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-orgheadline47" class="outline-2">
<h2 id="orgheadline47"><span class="section-number-2">1</span> future trade simulation</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-orgheadline2" class="outline-3">
<h3 id="orgheadline2"><span class="section-number-3">1.1</span> functions</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>calendar spread trading.</li>
</ul>

<p>
buy current month expired contract.
short next month expired contract.
</p>

<ul class="org-ul">
<li>rolling on constant maturity.
<ul class="org-ul">
<li>Goldman roll strategy:</li>
</ul></li>
</ul>
<p>
roll (with uniform weights) between the fifth and ninth business days of the month proceeding the expiration month.
</p>

<p>
The likely virtue of such a strategy in comparison to the
single-day strategy is that the user has a lower risk of being exposed to poor execution quality.
</p>

<ul class="org-ul">
<li>trend following on dominant contract.</li>
</ul>

<p>
moving average crossing over on the continous contract.
</p>
</div>

<div id="outline-container-orgheadline1" class="outline-4">
<h4 id="orgheadline1"><span class="section-number-4">1.1.1</span> constant maturity</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Negative roll yield can occur as an investor sells an expiring futures contract and simultaneously purchases a new contract. If the price of the new replacement contract is higher than the expiring contract, the transaction will yield a negative cash result, also known as negative roll yield.
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline15" class="outline-3">
<h3 id="orgheadline15"><span class="section-number-3">1.2</span> futures:</h3>
<div class="outline-text-3" id="text-1-2">
<p>
由期货交易所统一制定的、规定在将来某一特定的时间和地点交割一定数量和质量标的物的标准化合约。
</p>
</div>

<div id="outline-container-orgheadline3" class="outline-4">
<h4 id="orgheadline3"><span class="section-number-4">1.2.1</span> 期货合约命名规则：</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
品种名+交割月份
</p>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-4">
<h4 id="orgheadline6"><span class="section-number-4">1.2.2</span> 期货合约品种:</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
商品期货和金融期货。
</p>

<p>
商品期货又分工业品（可细分为金属商品（贵金属与非贵金属商品）、能源商品）、农产品、其他商品等。
</p>

<p>
金融期货主要是传统的金融商品（工具）如股指、利率、汇率等，各类期货交易包括期权交易等。
</p>
</div>

<ol class="org-ol"><li><a id="orgheadline4"></a>商品期货<br  /><div class="outline-text-5" id="text-1-2-2-1">
<ul class="org-ul">
<li>农产品期货：</li>
</ul>
<p>
如大豆、豆油、豆粕、籼稻、小麦、玉米、棉花、白糖、咖啡、猪腩、菜籽油、棕榈油。
</p>

<ul class="org-ul">
<li>金属期货：</li>
</ul>
<p>
如铜、铝、锡、铅、锌、镍、黄金、白银、螺纹钢、线材。
</p>

<ul class="org-ul">
<li>能源期货：</li>
</ul>
<p>
如原油（塑料、PTA、PVC）、汽油（甲醇）、燃料油。新兴品种包括气温、二氧化碳排放配额、天然橡胶。
</p>
</div></li>

<li><a id="orgheadline5"></a>金融期货<br  /><div class="outline-text-5" id="text-1-2-2-2">
<ul class="org-ul">
<li>股指期货：</li>
</ul>
<p>
如沪深300指数, 'IF'
</p>

<ul class="org-ul">
<li>利率期货（Interest rate futures）：</li>
</ul>
<p>
利率期货是指以债券类证券为标的物的期货合约，它可以避免利率波动所引起的证券价格变动的风险。利率期货一般可分为短期利率期货和长期利率期货，前者大多以银行同业拆借中场3月期利率为标的物、后者大多以5年期以上长期债券为标的物。
</p>

<ul class="org-ul">
<li>外汇期货(foreign exchange futures):</li>
</ul>
<p>
又称为货币期货，是一种在最终交易日按照当时的汇率将一种货币兑换成另外一种货币的期货合约。是指以汇率为标的物的期货合约，用来回避汇率风险。它是金融期货中最早出现的品种。
</p>

<ul class="org-ul">
<li>贵金属期货</li>
</ul>
<p>
主要以黄金、白银为标的物的期货合约。
</p>

<p>
贵金属按化学元素周期表命名，黄金为‘au’，白银为‘ag’。
</p>
</div></li></ol>
</div>

<div id="outline-container-orgheadline11" class="outline-4">
<h4 id="orgheadline11"><span class="section-number-4">1.2.3</span> 国内future exchange:</h4>
<div class="outline-text-4" id="text-1-2-3">
</div><ol class="org-ol"><li><a id="orgheadline7"></a>郑州商品交易所（ZCE）<br  /><div class="outline-text-5" id="text-1-2-3-1">
<p>
交易的品种有强筋小麦、普通小麦、PTA、一号棉花、白糖、菜籽油、早籼稻、玻璃、菜籽、菜粕、甲醇等16个期货品种.
</p>
</div></li>

<li><a id="orgheadline8"></a>上海期货交易所（SHFE）<br  /><div class="outline-text-5" id="text-1-2-3-2">
<p>
目前上市交易的有黄金、白银、铜、铝、锌、铅、螺纹钢、线材、燃料油、天然橡胶沥青等11个期货品种。
</p>
</div></li>

<li><a id="orgheadline9"></a>大连商品交易所（DCE）<br  /><div class="outline-text-5" id="text-1-2-3-3">
<p>
是中国东北地区唯一一家期货交易所。上市交易的有玉米、黄大豆1号、黄大豆2号、豆粕、豆油、棕榈油、聚丙烯、聚氯乙烯、塑料、焦炭、焦煤、铁矿石、胶合板、纤维板、鸡蛋等15个期货品种。
</p>
</div></li>

<li><a id="orgheadline10"></a>中国金融期货交易所（CFFEX）<br  /><div class="outline-text-5" id="text-1-2-3-4">
<p>
交易品种有股指期货，国债期货。
</p>
</div></li></ol>
</div>

<div id="outline-container-orgheadline12" class="outline-4">
<h4 id="orgheadline12"><span class="section-number-4">1.2.4</span> dominant_future - 期货主力合约</h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
合约首次上市时，以当日收盘同品种持仓量最大者作为从第二个交易日开始的主力合约。当同品种其他合约持仓量在收盘后超过当前主力合约1.1倍时，从第二个交易日开始进行主力合约的切换。日内不会进行主力合约的切换。
</p>
</div>
</div>

<div id="outline-container-orgheadline13" class="outline-4">
<h4 id="orgheadline13"><span class="section-number-4">1.2.5</span> trading calendar:</h4>
<div class="outline-text-4" id="text-1-2-5">
<ul class="org-ul">
<li>future calendar spread adjustment, 合成一个连续合约.</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline14" class="outline-4">
<h4 id="orgheadline14"><span class="section-number-4">1.2.6</span> future attributes:</h4>
<div class="outline-text-4" id="text-1-2-6">
<ul class="org-ul">
<li>root_symbol:</li>
</ul>
<p>
The root symbol of the underlying asset. For example, CL corresponds to crude oil.
</p>

<ul class="org-ul">
<li>start_date:</li>
</ul>
<p>
The date the contract becomes available on Quantopian. Note that the price of a contract might be NaN near the start_date, as it may not be actively traded until it gets closer to its delivery date.
</p>

<ul class="org-ul">
<li>end_date:</li>
</ul>
<p>
The last date the contract can be traded or closed before delivery.
</p>

<ul class="org-ul">
<li>notice_date:</li>
</ul>
<p>
The date in which the exchange can start assigning delivery to accounts holding long positions on the contract.
</p>

<ul class="org-ul">
<li>auto_close_date:</li>
</ul>
<p>
This is two days prior to either notice_date or end_date, whichever is earlier. In backtesting, positions in contracts will be automatically closed out on their auto_close_date.
</p>

<ul class="org-ul">
<li>tick_size:</li>
</ul>
<p>
The increment in which the price of the future can change. For example, CL changes in increments of $0.01.
</p>

<ul class="org-ul">
<li>multiplier:</li>
</ul>
<p>
The number of units per contract. For example, a contract for CL corresponds to 1000 barrels of oil.
</p>

<p>
参考各交易所各品种手册。
</p>

<p>
for example:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">交易品种</td>
<td class="org-left">黄金</td>
</tr>

<tr>
<td class="org-left">交易单位</td>
<td class="org-left">1000克/手</td>
</tr>

<tr>
<td class="org-left">报价单位</td>
<td class="org-left">元（人民币）/克</td>
</tr>

<tr>
<td class="org-left">最小变动价位</td>
<td class="org-left">0.05元/克</td>
</tr>

<tr>
<td class="org-left">每日价格最大波动限制</td>
<td class="org-left">不超过上一交易日结算价±3%</td>
</tr>

<tr>
<td class="org-left">合约交割月份</td>
<td class="org-left">最近三个连续月份的合约以及最近13个月以内的双月合约</td>
</tr>

<tr>
<td class="org-left">交易时间</td>
<td class="org-left">上午9:00－11:30 ，下午1:30－3:00和交易所规定的其他交易时间</td>
</tr>

<tr>
<td class="org-left">最后交易日</td>
<td class="org-left">合约交割月份的15日（遇法定假日顺延）</td>
</tr>

<tr>
<td class="org-left">交割日期</td>
<td class="org-left">最后交易日后连续五个工作日</td>
</tr>

<tr>
<td class="org-left">交割品级</td>
<td class="org-left">金含量不小于99.95%的国产金锭及经交易所认可的伦敦金银市场协会（LBMA）认定的合格供货商或精炼厂生产的标准金锭</td>
</tr>

<tr>
<td class="org-left">交割地点</td>
<td class="org-left">交易所指定交割金库</td>
</tr>

<tr>
<td class="org-left">最低交易保证金</td>
<td class="org-left">合约价值的4%</td>
</tr>

<tr>
<td class="org-left">交割方式</td>
<td class="org-left">实物交割</td>
</tr>

<tr>
<td class="org-left">交易代码</td>
<td class="org-left">AU</td>
</tr>

<tr>
<td class="org-left">上市交易所</td>
<td class="org-left">上海期货交易所</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orgheadline24" class="outline-3">
<h3 id="orgheadline24"><span class="section-number-3">1.3</span> 算法</h3>
<div class="outline-text-3" id="text-1-3">
</div><ol class="org-ol"><li><a id="orgheadline16"></a>future contract value:<br  /><div class="outline-text-5" id="text-1-3-0-1">
<p>
To better understand the need for continuous futures, let's get pricing data for the chain of individual contracts and plot it.
</p>


<div class="figure">
<p><img src="./images/futures_value.png" alt="futures_value.png" />
</p>
<p><span class="figure-number">Figure 1:</span> future contract</p>
</div>

<p>
The price difference between contracts at a given time is not considered to be an increase in value in the future. Instead, it is associated with the carrying cost and the opportunity cost of holding the underlying commodity or asset prior to delivery.
</p>

<div id="orgparagraph1" class="figure">
<p><img src="./images/active_contract.png" alt="active_contract.png" />
</p>
<p><span class="figure-number">Figure 2:</span> active contract</p>
</div>
</div></li>

<li><a id="orgheadline17"></a>adjustment styles<br  /><div class="outline-text-5" id="text-1-3-0-2">
<ul class="org-ul">
<li>multiplying</li>
</ul>
<p>
The Proportionality Adjustment approach is similar to the adjustment methodology of handling stock splits in equities. Rather than taking an absolute shift in the successive contracts, the ratio of the older settle (close) price to the newer open price is used to proportionally adjust the prices of historical contracts. This allows a continous stream without an interruption of the calculation of percentage returns.
</p>

<p>
The main issue with proportional adjustment is that any trading strategies reliant on an absolute price level will also have to be similarly adjusted in order to execute the correct signal. This is a problematic and error-prone process. <b>Thus this type of continuous stream is often only useful for summary statistical analysis, as opposed to direct backtesting research.</b>
</p>

<ul class="org-ul">
<li>add</li>
</ul>
<p>
What we have to do is adjust all previous prices up by the gap. This effectively "closes" the gap.
</p>

<p>
<b>The key problem with the Panama method includes the introduction of a trend bias, which will introduce a large drift to the prices. This can lead to negative data for sufficiently historical contracts. In addition there is a loss of the relative price differences due to an absolute shift in values. This means that returns are complicated to calculate (or just plain incorrect).</b>
</p>

<ul class="org-ul">
<li>Rollover/Perpetual Series</li>
</ul>
<p>
The essence of this approach is to create a continuous contract of successive contracts by taking a linearly weighted proportion of each contract over a number of days to ensure a smoother transition between each.
</p>

<p>
For example consider five smoothing days. The price on day 1, P1, is equal to 80% of the far contract price (F1) and 20% of the near contract price (N1). Similarly, on day 2 the price is P2=0.6×F2+0.4×N2P2=0.6×F2+0.4×N2. By day 5 we have P5=0.0×F5+1.0×N5=N5 and the contract then just becomes a continuation of the near price. Thus after five days the contract is smoothly transitioned from the far to the near.
</p>

<p>
The problem with the rollover method is that it requires trading on all five days, which can increase transaction costs.
</p>

<ul class="org-ul">
<li>None</li>
</ul>
<p>
Doing nothing.
</p>
</div></li>

<li><a id="orgheadline21"></a>roll styles<br  /><div class="outline-text-5" id="text-1-3-0-3">
<p>
[<a href="https://www.quandl.com/data/SCF-Continuous-Futures/documentation/roll-methodology">https://www.quandl.com/data/SCF-Continuous-Futures/documentation/roll-methodology</a>]
</p>

<p>
There are 14 different roll rule and price rule combinations, corresponding to all the different use cases for futures data. It is strongly recommended that you use continuous contracts with the correct roll/price rule, if you want your analysis to be accurate and trustworthy. Incorrect concatenation rules or inappropriate use of individual illiquid contracts may seriously impair the quality of your analysis.
</p>
</div>

<ol class="org-ol"><li><a id="orgheadline18"></a>What are the different roll date choices available?<br  /><div class="outline-text-6" id="text-1-3-0-3-1">
<p>
Roll date choices include:
</p>

<ul class="org-ul">
<li>On the last trading day of the expiring contract. This method is called the last-trading-day or end-to-end roll method. This method allows you to use the front contract for as long as possible; however the danger is that activity may have switched to the back contract prior to your roll. A trading strategy based upon this rule runs the risk of unwanted delivery and/or close-out of your positions, if you do not roll in time (the margin for error is very limited). This is the roll date rule used in Quandl's free continuous futures data (source /CHRIS).</li>

<li>On the first day of the contract delivery month or on the contract end date, whichever is sooner. This is called the first-of-month roll method, and is used by most major data terminals as their default roll method. It has the advantage that it is uniform across all contracts, and completely predictable. However, this method has very little connection with the underlying mechanics of the contract; it is connected neither to the contract's trading activity, nor to its specific delivery rules. We recommend using this method only for purely deterministic trading strategies which do not rely on behavioral patterns for their returns.</li>

<li>On the first day that the back contract has a higher open interest than the front contract. This is called the open-interest-switch or liquidity-based roll method, and is used by most technical traders, especially in financial futures. It is also used by macro traders who are primarily concerned with larger longer-term trends, and are hence agnostic to minor differences in valuation within a given commodity complex. This roll rule, by definition, offers the highest liquidity to traders. However, note that it is completely inappropriate for interest rates futures, and should be used with care for energy and agriculture futures.</li>
</ul>
</div></li>
<li><a id="orgheadline19"></a>What are the different price adjustment choices available?<br  /><div class="outline-text-6" id="text-1-3-0-3-2">
<p>
Price adjustment choices include:
</p>

<ul class="org-ul">
<li>No price adjustment: the simplest choice. The prices you see are always actual transaction prices; however, there are discontinuous jumps in the long-term futures price history.</li>

<li>Forwards panama canal method, aka first-true method. Shift successive contracts up or down by a constant amount so as to eliminate jumps, working forwards from the oldest contract in your history. The price of the oldest contract will therefore be "true"; all others will be adjusted.</li>

<li>Backwards panama canal method, aka last-true method. Shift successive contracts up or down by a constant amount so as to eliminate jumps, working backwards from the current contract. The price of the current continuous contract will be "true" and match market prices; however, you will need to recalculate your entire history on every roll date, which may be impractical.</li>

<li>Backwards ratio method. Instead of shifting contracts up or down, in this method we multiply contracts by a constant factor so as to eliminate jumps, working backwards from the current contract. As with the backwards panama canal method, this method necessitates full historical recalculation on every roll date.</li>

<li>Calendar-weighted method. Transition smoothly from one contract to the next, by using blended or weighted-average combined prices during a pre-determined transition window right around the roll date. This method is an elegant compromise between first-true and last-true methods: like first-true, it requires no historical recalculation, and like last-true, it delivers continuous prices that exactly match current market prices. However, this method cannot be used in conjunction with non-predictable roll dates such as open-interest-switch.</li>
</ul>

<p>
With 3 roll rules and 5 price rules in play, there are 15 possible price/roll combinations &#x2013; minus 1, because calendar-weighted prices are incompatible with open-interest-switch rolling. So there are 14 price/roll combinations available as part of the SCF futures database.
</p>
</div></li>

<li><a id="orgheadline20"></a>Which roll date and price adjustment should I use?<br  /><div class="outline-text-6" id="text-1-3-0-3-3">
<p>
It depends on your use case.
</p>

<p>
If you are using continuous contracts for <b>economic forecasting or regression</b>, you should use *"first day of month" as your roll date rule, and "calendar-weighted rolling" as your price adjustment rule*. These two choices are perfectly deterministic, predictable, and smooth; furthermore they do not contaminate any economic aspects of the price history.
</p>

<p>
If you are using continuous contracts for <b>chart-based technical analysis</b>, you should use *"open interest switch" as your roll date rule*. Technical analysis depends on finding patterns in trader group dynamics, and hence a popularity-based roll measure is appropriate. For your price adjustment rule, you can use either *"backwards panama" with a linear y-axis, or "backwards ratio" with a logarithmic y-axis*, depending on your =preferred flavor of technical analysis. (Although some traders claim that "unadjusted" prices are more appropriate, since they correspond more closely with psychological perceptions of support, resistance etc.)
</p>

<p>
If you are using continuous contracts for <b>back-testing trading strategies</b>, you should use <b>a roll date rule that corresponds exactly to your trading strategy</b>. If you always roll on the expiry date, use "last trading day". If you always roll on the first of the month, use "first day of month". If you roll when everybody else rolls (for benchmarking or liquidity reasons), use "open interest switch". As for prices: <b>if you trade based on a constant number of contracts</b>, you should use "<b>backwards Panama</b>" as your price adjustment rule. If you trade based on <b>a constant value of the underlying commodity</b>, you should use "<b>backwards ratio</b>" for your price adjustment rule, and be sure to calculate PL using relative (percentage) changes not absolute (price) changes.
</p>

<p>
Many experienced futures analysts use different roll/price rules in different parts of their workflow. For example, sophisticated technical traders often use open-interest-switch-roll and unadjusted-prices (code: 'ON') in order to make buy/sell decisions; this splicing method combines maximum liquidity with accurate nominal prices, and thus matches well with mass psychology. But when it comes to back-testing their buy/sell decisions, they use first-of-month-roll and calendar-weighted-prices, since that gives the most accurate, unbiased estimate of historical PL. So the same spreadsheet or backtester can in fact incorporate different roll/price rules, depending on where they're being used. This kind of advanced analysis is simply not possible without the SCF database, unless you're willing to invest huge amounts of time to build your own custom histories.
</p>

<p>
Here are some examples of what not to do. If you're trading Fed Funds or Eurodollar futures, an open-interest-switch rule is inappropriate, because most of the "action" is in the back contracts. If you're back-testing a trading strategy, you should not use unadjusted prices, because that will introduce artifical PL from roll date jumps. If you're trading a commodity with heavy contango or backwardation, you should not use Panama canal shifts, because they will lead to negative prices. If you're trading equities or currencies, you should never look at the #2 or #3 contracts, because they are utterly illiquid. And so on.
</p>
</div></li></ol></li>


<li><a id="orgheadline22"></a>Slippage<br  /><div class="outline-text-5" id="text-1-3-0-4">
<p>
<a href="https://www.quantopian.com/tutorials/futures-getting-started#lesson11">https://www.quantopian.com/tutorials/futures-getting-started#lesson11</a>
</p>

<p>
<a href="https://www.quantopian.com/posts/quantopians-slippage-model-for-futures%20">https://www.quantopian.com/posts/quantopians-slippage-model-for-futures%20</a>
</p>

<p>
When an order is placed for a contract, the market is affected. Buy orders drive prices up, and sell orders drive prices down; this is generally referred to as the price impact of a trade. Additionally, orders do not necessarily fill instantaneously. Fill rates are dependent on the order size and current trading volume of the ordered contract.
</p>

<p>
On Quantopian, slippage on futures contracts is calculated using a special volatility volume share model. The volatility volume share model uses trailing 20-day trading volume and volatility to compute the price impact and fill rate of an order. Each underlying commodity/asset has its own model fit to historical data.
</p>

<div class="figure">
<p><img src="./images/market_impact.png" alt="market_impact.png" />
</p>
<p><span class="figure-number">Figure 3:</span> market impact</p>
</div>
</div></li>

<li><a id="orgheadline23"></a>commission:<br  /><div class="outline-text-5" id="text-1-3-0-5">
<p>
commissions charged per contract as well as exchange fees charged per trade.
</p>

<p>
仓位金：总资金*（X%-Y%）；
</p>

<p>
单笔最大允许亏损额&lt;=总资产*Z%；
</p>

<p>
单手开仓价：（现价*交易单位*保证金）+手续费；
</p>

<p>
默认手数（最大开仓）：仓位金/单手开仓价；
</p>

<p>
期货品种波动一个价位的值：最小变动价*交易单位*开仓手数；
</p>
</div></li></ol>
</div>

<div id="outline-container-orgheadline46" class="outline-3">
<h3 id="orgheadline46"><span class="section-number-3">1.4</span> backtesting</h3>
<div class="outline-text-3" id="text-1-4">
</div><div id="outline-container-orgheadline25" class="outline-4">
<h4 id="orgheadline25"><span class="section-number-4">1.4.1</span> 回测初始化参数(setting initial parameters)：</h4>
<div class="outline-text-4" id="text-1-4-1">
<ul class="org-ul">
<li>start :</li>
</ul>
<p>
回测开始时间，支持格式：datetime.datetime | "%Y-%m-%d"。大众版的回测功能，支持回测过去一年的合约
</p>

<ul class="org-ul">
<li>end :</li>
</ul>
<p>
回测结束时间，支持格式：datetime.datetime | "%Y-%m-%d"
</p>

<ul class="org-ul">
<li>universe :</li>
</ul>
<p>
合约代码池，可以设置为具体合约或主力合约。例如：["IF1601", "IF1602"] 或 ["RB1601"]
</p>

<ul class="org-ul">
<li>capital_base :</li>
</ul>
<p>
初始现金
</p>

<ul class="org-ul">
<li>refresh_rate :</li>
</ul>
<p>
调仓周期
</p>

<ul class="org-ul">
<li>freq :</li>
</ul>
<p>
调仓频率，m-&gt; 分钟；d-&gt; 日；
</p>
</div>
</div>

<div id="outline-container-orgheadline45" class="outline-4">
<h4 id="orgheadline45"><span class="section-number-4">1.4.2</span> backtesting：</h4>
<div class="outline-text-4" id="text-1-4-2">
</div><ol class="org-ol"><li><a id="orgheadline37"></a>initialize(futures_account)：<br  /><div class="outline-text-5" id="text-1-4-2-1">
<p>
该函数在在系统初始化后被调用一次；
</p>

<p>
可以通过给 futures_account 添加新的属性的方法，自定义各种指标变量等等；
</p>
</div>

<ol class="org-ol"><li><a id="orgheadline36"></a>futures_account：<br  /><div class="outline-text-6" id="text-1-4-2-1-1">
<p>
策略回测、模拟交易中的账户，策略初始化之前，会建立一个交易账户futures_account，在这个账户会存储上述全局变量参数信息，并在整个策略执行期间更新并维护可用现金、期货头寸、每日交易订单委托明细等。futures_account会在策略整个回测期间存续。
</p>
</div>

<ol class="org-ol"><li><a id="orgheadline35"></a>futures_account对象属性<br  /><ol class="org-ol"><li><a id="orgheadline26"></a>universe<br  /><div class="outline-text-8" id="text-1-4-2-1-1-1-1">
<p>
表示当前交易日的期货合约集合，与初始化参数的universe相对应。
</p>
<div class="org-src-container">

<pre class="src src-python">futures_account.universe
</pre>
</div>
</div></li>

<li><a id="orgheadline27"></a>previous_date<br  /><div class="outline-text-8" id="text-1-4-2-1-1-1-2">
<p>
上一个交易日，格式："YYYY-MM-DD"
</p>
<div class="org-src-container">

<pre class="src src-python">futures_account.previous_date
</pre>
</div>
</div></li>

<li><a id="orgheadline28"></a>cash<br  /><div class="outline-text-8" id="text-1-4-2-1-1-1-3">
<p>
当前账户可用现金.
</p>
<div class="org-src-container">

<pre class="src src-python">futures_account.cash
</pre>
</div>
</div></li>

<li><a id="orgheadline29"></a>portfolio_value<br  /><div class="outline-text-8" id="text-1-4-2-1-1-1-4">
<p>
当前账户权益.
</p>
<div class="org-src-container">

<pre class="src src-python">futures_account.portfolio_value
</pre>
</div>
</div></li>

<li><a id="orgheadline30"></a>position<br  /><div class="outline-text-8" id="text-1-4-2-1-1-1-5">
<p>
账户持仓记录. 品种持仓明细为 dict ， 可以使用 get 方法获取各属性.
</p>
<div class="org-src-container">

<pre class="src src-python">futures_account.position

 <span style="color: #AE81FF;">{</span>
   <span style="color: #E6DB74;">'IF1603'</span>: <span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">'short_position'</span>: <span style="color: #AE81FF;">0</span>.<span style="color: #AE81FF;">0</span>, <span style="color: #E6DB74;">'short_margin'</span>: <span style="color: #AE81FF;">0</span>.<span style="color: #AE81FF;">0</span>, <span style="color: #E6DB74;">'long_margin'</span>: <span style="color: #AE81FF;">473880</span>.<span style="color: #AE81FF;">0</span>, <span style="color: #E6DB74;">'long_position'</span>: <span style="color: #AE81FF;">3</span>.<span style="color: #AE81FF;">0</span>, <span style="color: #E6DB74;">'today_profit'</span>: <span style="color: #AE81FF;">1</span>, <span style="color: #E6DB74;">'profit'</span>: <span style="color: #AE81FF;">100</span><span style="color: #66D9EF;">}</span>&#65292;
   <span style="color: #E6DB74;">'RB1606'</span>: <span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">'short_position'</span>: <span style="color: #AE81FF;">1</span>.<span style="color: #AE81FF;">0</span>, <span style="color: #E6DB74;">'short_margin'</span>: <span style="color: #AE81FF;">4230</span>.<span style="color: #AE81FF;">0</span>, <span style="color: #E6DB74;">'long_margin'</span>: <span style="color: #AE81FF;">0</span>.<span style="color: #AE81FF;">0</span>, <span style="color: #E6DB74;">'long_position'</span>: <span style="color: #AE81FF;">0</span>.<span style="color: #AE81FF;">0</span>, <span style="color: #E6DB74;">'today_profit'</span>:-<span style="color: #AE81FF;">1</span>, <span style="color: #E6DB74;">'profit'</span>:<span style="color: #AE81FF;">10</span><span style="color: #66D9EF;">}</span>
 <span style="color: #AE81FF;">}</span>
</pre>
</div>
</div></li>

<li><a id="orgheadline31"></a>futures_position<br  /><div class="outline-text-8" id="text-1-4-2-1-1-1-6">
<p>
账户持仓记录. 品种持仓明细为 Position 对象， 可以使用.方法获取各属性.
</p>
<div class="org-src-container">

<pre class="src src-python">futures_account.futures_position
</pre>
</div>
</div></li>

<li><a id="orgheadline32"></a>trades<br  /></li>

<li><a id="orgheadline33"></a>close_all_positions<br  /></li>

<li><a id="orgheadline34"></a>switch_position<br  /><div class="outline-text-8" id="text-1-4-2-1-1-1-9">
<p>
移仓操作，下达由symbol_from至symbol_to相同数量的平仓及开仓指令（含多空持仓)。
</p>
<div class="org-src-container">

<pre class="src src-python">futures_account.switch_position<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">'IF1603'</span>, <span style="color: #E6DB74;">'IF1604'</span><span style="color: #AE81FF;">)</span>
futures_account.switch_position<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">'M1605'</span>, <span style="color: #E6DB74;">'M1609'</span><span style="color: #AE81FF;">)</span>
</pre>
</div>
</div></li></ol></li></ol></li></ol></li>

<li><a id="orgheadline43"></a>handle_data(futures_account) ：<br  /><div class="outline-text-5" id="text-1-4-2-2">
<p>
这个函数根据freq和refresh_rate字段指定的频率被调用，交易策略可以根据历史数据或者其他信息进行分析判断，并下达交易指令；
系统回测引擎会根据当天的市场数据对这些指令进行能否交易的判断，并更新 futures_account 当中的现金数量、期货头寸和订单委托信息；
该交易日结束，会重置未成交的订单委托。
</p>

<p>
随后该交易日结束，在该函数中定义的局部变量会被清空，循环进入下一个交易日，即继续调用handle_data函数。
</p>
</div>

<ol class="org-ol"><li><a id="orgheadline38"></a>simple mode(only calculate the position value on continious contract)<br  /><div class="outline-text-6" id="text-1-4-2-2-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #75715E;">### </span><span style="color: #75715E;">&#31574;&#30053;&#22238;&#27979;&#21442;&#25968;</span>
<span style="color: #FD971F;">universe</span> = <span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">'RBM0'</span><span style="color: #AE81FF;">]</span>                  <span style="color: #75715E;"># </span><span style="color: #75715E;">&#31574;&#30053;&#20132;&#26131;&#30340;&#26399;&#36135;&#21512;&#32422;&#65292;&#27492;&#22788;&#36873;&#25321;&#34746;&#32441;&#38050;&#20027;&#21147;&#21512;&#32422;</span>
<span style="color: #FD971F;">start</span> = <span style="color: #E6DB74;">"2016-06-30"</span>                 <span style="color: #75715E;"># </span><span style="color: #75715E;">&#22238;&#27979;&#24320;&#22987;&#26102;&#38388;</span>
<span style="color: #FD971F;">end</span>   = <span style="color: #E6DB74;">"2016-08-16"</span>                 <span style="color: #75715E;"># </span><span style="color: #75715E;">&#22238;&#27979;&#32467;&#26463;&#26102;&#38388;</span>
<span style="color: #FD971F;">capital_base</span> = <span style="color: #AE81FF;">1000000</span>               <span style="color: #75715E;"># </span><span style="color: #75715E;">&#21021;&#22987;&#21487;&#29992;&#36164;&#37329;</span>
<span style="color: #FD971F;">refresh_rate</span> = <span style="color: #AE81FF;">1</span>                     <span style="color: #75715E;"># </span><span style="color: #75715E;">&#31639;&#27861;&#35843;&#29992;&#21608;&#26399;</span>
<span style="color: #FD971F;">freq</span> = <span style="color: #E6DB74;">'d'</span>                           <span style="color: #75715E;"># </span><span style="color: #75715E;">&#31639;&#27861;&#35843;&#29992;&#39057;&#29575;&#65306;m-&gt; &#20998;&#38047;&#65307;d-&gt; &#26085;&#65307;</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">&#31574;&#30053;&#21021;&#22987;&#21270;&#20989;&#25968;</span>
<span style="color: #F92672;">def</span> <span style="color: #A6E22E;">initialize</span><span style="color: #AE81FF;">(</span>futures_account<span style="color: #AE81FF;">)</span>:
    <span style="color: #F92672;">pass</span>


<span style="color: #75715E;"># </span><span style="color: #75715E;">generate signal according to continious contract.</span>
<span style="color: #F92672;">def</span> <span style="color: #A6E22E;">generate_signal</span><span style="color: #AE81FF;">(</span>future.universe<span style="color: #AE81FF;">)</span>:
    <span style="color: #FD971F;">symbol</span> = get_symbol<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">'RBM0'</span><span style="color: #AE81FF;">)</span>
    <span style="color: #FD971F;">signal</span> = algorithm<span style="color: #AE81FF;">()</span>
    <span style="color: #F92672;">return</span> position_on_continious_contract


<span style="color: #75715E;"># </span><span style="color: #75715E;">&#22238;&#27979;&#31639;&#27861;&#36923;&#36753;&#65292;&#27599;&#20010;bar&#36816;&#34892;&#19968;&#27425;</span>
<span style="color: #F92672;">def</span> <span style="color: #A6E22E;">handle_data</span><span style="color: #AE81FF;">(</span>futures_account<span style="color: #AE81FF;">)</span>:
    <span style="color: #FD971F;">symbol</span> = get_symbol<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">'RBM0'</span><span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">get the specific contracts list behind rbm0.</span>

    <span style="color: #F92672;">if</span> open_signal:
        <span style="color: #F92672;">if</span> <span style="color: #F92672;">not</span> futures_account.position:
            <span style="color: #F92672;">print</span> futures_account.current_date, <span style="color: #E6DB74;">'&#20080;&#20837;&#24320;&#20179;'</span>
            order<span style="color: #AE81FF;">(</span>symbol, <span style="color: #AE81FF;">1</span>, <span style="color: #E6DB74;">'open'</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">elif</span> close_signal:
        <span style="color: #F92672;">print</span> futures_account.current_date, <span style="color: #E6DB74;">'&#21334;&#20986;&#24179;&#20179;'</span>
        order<span style="color: #AE81FF;">(</span>symbol, -<span style="color: #AE81FF;">1</span>, <span style="color: #E6DB74;">'close'</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">else</span>:
        <span style="color: #F92672;">pass</span>

    <span style="color: #F92672;">if</span> contract changes:
        futures_account.switch_position<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">'RBM1603'</span>, <span style="color: #E6DB74;">'RBM1604'</span><span style="color: #AE81FF;">)</span>
</pre>
</div>
</div></li>

<li><a id="orgheadline39"></a>pseudo code:<br  /><div class="outline-text-6" id="text-1-4-2-2-2">
<p>
1). 策略初始化函数
</p>

<p>
可以通过给 futures_account 添加新的属性的方法，自定义各种指标变量等等；
</p>

<p>
策略回测、模拟交易中的账户，策略初始化之前，会建立一个交易账户futures_account，在这个账户会存储上述全局变量参数信息，并在整个策略执行期间更新并维护可用现金、期货头寸、每日交易订单委托明细等。futures_account会在策略整个回测期间存续。
</p>

<p>
2). 循环futures_account.universe里面的合约的交易日历.
</p>

<p>
如果有交易信号发生：
</p>

<p>
如果没有相关合约头寸：
</p>

<p>
建立头寸
</p>

<p>
如果有相关合约头寸：
</p>

<p>
关闭头寸
</p>

<p>
如果连续合约背后的具体合约发生变化：
</p>

<p>
如果有头寸：
</p>

<p>
在每个最小交易bar检测到合约发生变化，如果持有合约，switch_position。
移仓操作，下达由symbol_from至symbol_to相同数量的平仓及开仓指令（含多空持仓)。
</p>
</div></li>


<li><a id="orgheadline40"></a>advanced mode(calculate the position value based on continious contract and actual contract)<br  /></li>

<li><a id="orgheadline42"></a>订单委托方法<br  /><ol class="org-ol"><li><a id="orgheadline41"></a>order<br  /><div class="outline-text-7" id="text-1-4-2-2-4-1">
<div class="org-src-container">

<pre class="src src-python">order<span style="color: #AE81FF;">(</span>symbol, amount, offset_flag, order_type=<span style="color: #E6DB74;">'market'</span>, price=<span style="color: #AE81FF;">0</span>.<span style="color: #AE81FF;">)</span>
</pre>
</div>
</div></li></ol></li></ol></li>

<li><a id="orgheadline44"></a>策略结果<br  /><div class="outline-text-5" id="text-1-4-2-3">
<p>
回测result，格式为pandas.DataFrame，以交易日期为索引，包含以下字段：
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">trade_date</td>
<td class="org-left">str</td>
<td class="org-left">策略对应的交易日</td>
</tr>

<tr>
<td class="org-left">futures_blotter</td>
<td class="org-left">list</td>
<td class="org-left">Order对象，当日结算时的订单委托明细</td>
</tr>

<tr>
<td class="org-left">futures_cash</td>
<td class="org-left">float</td>
<td class="org-left">当日结算后的账户可用现金</td>
</tr>

<tr>
<td class="org-left">futures_position</td>
<td class="org-left">list</td>
<td class="org-left">Dict对象，当日结算后的持仓明细</td>
</tr>

<tr>
<td class="org-left">futures_trades</td>
<td class="org-left">list</td>
<td class="org-left">Trade对象，当日结算时的订单成交明细</td>
</tr>

<tr>
<td class="org-left">portfolio_value</td>
<td class="org-left">float</td>
<td class="org-left">当日结算后的用户权益</td>
</tr>
</tbody>
</table>
</div></li></ol>
</div>
</div>
</div>
</div>
</body>
</html>
